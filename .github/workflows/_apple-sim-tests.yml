name: _Apple Simulator Tests (Reusable)

on:
  workflow_call:
    inputs:
      workflow-name:
        required: true
        type: string
      scheme:
        required: true
        type: string
      sim-runtime-prefix:
        required: true
        type: string
      device-name-regex:
        required: false
        type: string
        default: ".*"
      oldest-os:
        required: true
        type: string
      latest-os:
        required: true
        type: string
      xcode-old:
        required: true
        type: string
      xcode-new:
        required: true
        type: string

jobs:
  test:
    name: "${{ inputs.workflow-name }} | ${{ matrix.lane }} | Xcode ${{ matrix.xcode }}"
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - lane: oldest
            requested_os: ${{ inputs.oldest-os }}
            xcode: ${{ inputs.xcode-old }}
          - lane: latest
            requested_os: ${{ inputs.latest-os }}
            xcode: ${{ inputs.xcode-new }}

    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode }}

      - uses: ./.github/actions/ensure-swift

      - name: Resolve simulator destination
        id: sim
        shell: bash
        env:
          RUNTIME_PREFIX: ${{ inputs.sim-runtime-prefix }}
          DEVICE_REGEX: ${{ inputs.device-name-regex }}
          REQUESTED_OS: ${{ matrix.requested_os }}
          LANE: ${{ matrix.lane }}
        run: |
          set -euo pipefail
          python3 <<'PY'
          import json, os, re, subprocess, sys

          prefix = os.environ["RUNTIME_PREFIX"]  # ex: com.apple.CoreSimulator.SimRuntime.iOS
          pattern = re.compile(os.environ["DEVICE_REGEX"])
          requested = os.environ["REQUESTED_OS"]  # ex: 12.0 or 26.2
          lane = os.environ["LANE"]               # oldest/latest

          data = json.loads(subprocess.check_output(
              ["xcrun", "simctl", "list", "devices", "available", "--json"], text=True))

          def parse_ver(v):
            return tuple(int(x) for x in v.split("."))

          def runtime_ver(runtime_key):
            # runtime key format: com.apple.CoreSimulator.SimRuntime.iOS-18-2
            m = re.search(r'-(\d+)(?:-(\d+))?(?:-(\d+))?$', runtime_key)
            if not m:
              return (0, 0, 0)
            a = int(m.group(1))
            b = int(m.group(2) or 0)
            c = int(m.group(3) or 0)
            return (a, b, c)

          candidates = []
          for runtime_key, devices in data.get("devices", {}).items():
            if not runtime_key.startswith(prefix + "-"):
              continue
            rv = runtime_ver(runtime_key)
            for d in devices:
              if not d.get("isAvailable", False):
                continue
              name = d.get("name", "")
              if not pattern.search(name):
                continue
              candidates.append((rv, runtime_key, d["udid"], name))

          if not candidates:
            print("No simulator candidates found.", file=sys.stderr)
            sys.exit(1)

          req_tuple = parse_ver(requested)
          exact = [c for c in candidates if c[0][:2] == req_tuple[:2]]

          chosen = None
          if exact:
            exact.sort(key=lambda x: x[0])
            chosen = exact[0] if lane == "oldest" else exact[-1]
          else:
            # fallback to oldest/newest available for that platform
            candidates.sort(key=lambda x: x[0])
            chosen = candidates[0] if lane == "oldest" else candidates[-1]

          rv, runtime_key, udid, name = chosen
          print(f"Using simulator: {name} | runtime={runtime_key} | udid={udid}")

          out = open(os.environ["GITHUB_OUTPUT"], "a")
          out.write(f"destination=id={udid}\n")
          out.write(f"runtime_key={runtime_key}\n")
          out.close()
          PY

      - name: Run tests
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies -scheme "${{ inputs.scheme }}"
          xcodebuild test \
            -scheme "${{ inputs.scheme }}" \
            -destination "${{ steps.sim.outputs.destination }}" \
            -skipPackagePluginValidation \
            -skipMacroValidation

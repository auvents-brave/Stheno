name: Build Windows
permissions:
  contents: read
on:
  workflow_dispatch:
  #push:
  #  branches:
  #pull_request:
  #  branches:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:

  build-windows:
    name: Build on Windows with Swift 6.2
    runs-on: windows-2025
    steps:
      - uses: actions/checkout@v4

      - name: Ensure Swift 6.2 Toolchain
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $toolchainRoot = "C:\Library\Developer\Toolchains\swift-6.2-RELEASE-windows10.xctoolchain"
          $installPath = Join-Path $toolchainRoot "usr\bin"
          $sdkRoot = "C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk"
          $toolchainVersionMatches = $false
          $swiftCommand = Get-Command swift -ErrorAction SilentlyContinue
          if ($swiftCommand) {
            $swiftVersion = swift --version
            if ($swiftVersion | Select-String -Pattern "6\.2") {
              Write-Host "Swift 6.2 already installed."
              $toolchainVersionMatches = $true
            }
          }

          if (-not $toolchainVersionMatches) {
            Write-Host "Swift 6.2 not found. Installing prerequisites and Swift toolchain..."
            curl -LO https://aka.ms/vs/17/release/vs_buildtools.exe
            Start-Process -FilePath .\vs_buildtools.exe -ArgumentList @(
              "--quiet",
              "--wait",
              "--norestart",
              "--nocache",
              "--installPath", "C:\BuildTools",
              "--add", "Microsoft.VisualStudio.Component.Windows11SDK.22000",
              "--add", "Microsoft.VisualStudio.Component.VC.Tools.x86.x64",
              "--add", "Microsoft.VisualStudio.Component.VC.Tools.ARM64"
            ) -Wait

            Invoke-WebRequest -Uri https://download.swift.org/swift-6.2-release/windows10/swift-6.2-RELEASE/swift-6.2-RELEASE-windows10.exe -OutFile swift-installer.exe
            Start-Process -FilePath .\swift-installer.exe -ArgumentList "/quiet" -Wait

            Remove-Item -Force vs_buildtools.exe, swift-installer.exe -ErrorAction SilentlyContinue
          }

          if (-not (Test-Path $installPath)) {
            throw "Expected Swift installation path not found: $installPath"
          }

          $installPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          if (Test-Path $sdkRoot) {
            "SDKROOT=$sdkRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Verify Swift 6.2
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $toolchainRoot = "C:\Library\Developer\Toolchains\swift-6.2-RELEASE-windows10.xctoolchain"
          $installPath = Join-Path $toolchainRoot "usr\bin"
          $sdkRoot = "C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk"
          if (Test-Path $installPath) {
            $env:Path = "$installPath;$($env:Path)"
          }
          if (Test-Path $sdkRoot) {
            $env:SDKROOT = $sdkRoot
          }
          $swiftVersion = swift --version
          $swiftVersion
          if (-not ($swiftVersion | Select-String -Pattern "6\.2")) {
            throw "Swift 6.2 not detected. Output was: $swiftVersion"
          }

      - name: Run Tests
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $toolchainRoot = "C:\Library\Developer\Toolchains\swift-6.2-RELEASE-windows10.xctoolchain"
          $installPath = Join-Path $toolchainRoot "usr\bin"
          $sdkRoot = "C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk"
          if (Test-Path $installPath) {
            $env:Path = "$installPath;$($env:Path)"
          }
          if (Test-Path $sdkRoot) {
            $env:SDKROOT = $sdkRoot
          }
          swift test

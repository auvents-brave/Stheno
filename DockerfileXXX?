FROM swift:latest AS stheno

# Set base environment variables for locale and timezone
ENV TZ="Europe/Paris" \
    LANG="fr_FR.UTF-8" \
    LANGUAGE="fr_FR:fr" \
    LC_ALL="fr_FR.UTF-8"

# First set up the locale and timezone
RUN apt-get update && \
    DEBIAN_FRONTEND="noninteractive" apt-get install -y locales tzdata && \
    rm -rf /var/lib/apt/lists/* && \
    echo "$LOCAL_LOCALE UTF-8" > /etc/locale.gen && \
    locale-gen "$LOCAL_LOCALE" && \
    update-locale LANG="$LOCAL_LOCALE" && \
    ln -fs "/usr/share/zoneinfo/$LOCAL_TIMEZONE" /etc/localtime && \
    echo "$LOCAL_TIMEZONE" > /etc/timezone && \
    dpkg-reconfigure --frontend noninteractive tzdata

# Copy and run the locale configuration script
COPY configure_locale.swift /tmp/
RUN swift /tmp/configure_locale.swift

# Verify the locale setting
RUN swift -e 'import Foundation; print("Current locale: \(Locale.current.identifier)"); print("Preferred languages: \(Locale.preferredLanguages)")'

# Set the environment variables for the locale
ENV LANG="$LOCAL_LOCALE" \
    LANGUAGE="$LOCAL_LANGUAGE" \
    LC_ALL="$LOCAL_LOCALE" \
    LC_CTYPE="$LOCAL_LOCALE" \
    LC_COLLATE="$LOCAL_LOCALE" \
    LC_TIME="$LOCAL_LOCALE" \
    LC_NUMERIC="$LOCAL_LOCALE" \
    LC_MONETARY="$LOCAL_LOCALE" \
    LC_MESSAGES="$LOCAL_LOCALE" \
    LC_PAPER="$LOCAL_LOCALE" \
    LC_NAME="$LOCAL_LOCALE" \
    LC_ADDRESS="$LOCAL_LOCALE" \
    LC_TELEPHONE="$LOCAL_LOCALE" \
    LC_MEASUREMENT="$LOCAL_LOCALE" \
    LC_IDENTIFICATION="$LOCAL_LOCALE"
ENV TZ=$LOCAL_TIMEZONE

RUN echo ${LC_IDENTIFICATION}
RUN echo ${TZ}
RUN echo $TZ

RUN swift --version

# Build the LocalizedEnvironment and test locale settings
COPY . /app
WORKDIR /app

RUN swift build
RUN swift -e '\
    import Stheno;\
    LocalizedEnvironment.setup();\
    LocalizedEnvironment.printSettings();\
    '

COPY . /app
WORKDIR /app

RUN ls





FROM swift:latest AS final

# Set up locale in final stage
ENV LANG="fr_FR.UTF-8" \
    LANGUAGE="fr_FR:fr" \
    LC_ALL="fr_FR.UTF-8" \
    LC_CTYPE="fr_FR.UTF-8" \
    LC_COLLATE="fr_FR.UTF-8" \
    LC_TIME="fr_FR.UTF-8" \
    LC_NUMERIC="fr_FR.UTF-8" \
    LC_MONETARY="fr_FR.UTF-8" \
    LC_MESSAGES="fr_FR.UTF-8" \
    LC_PAPER="fr_FR.UTF-8" \
    LC_NAME="fr_FR.UTF-8" \
    LC_ADDRESS="fr_FR.UTF-8" \
    LC_TELEPHONE="fr_FR.UTF-8" \
    LC_MEASUREMENT="fr_FR.UTF-8" \
    LC_IDENTIFICATION="fr_FR.UTF-8"

# Install and configure locale in final stage
RUN apt-get update && \
    DEBIAN_FRONTEND="noninteractive" apt-get install -y locales tzdata && \
    rm -rf /var/lib/apt/lists/* && \
    echo "fr_FR.UTF-8 UTF-8" > /etc/locale.gen && \
    locale-gen && \
    update-locale LANG=fr_FR.UTF-8

COPY --from=stheno /app /app
WORKDIR /app



RUN swift --version

RUN swift -e 'import Foundation; print(Locale.current.identifier)'